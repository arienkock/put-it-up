<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Boards Overview - Whiteboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/global.css" />
  </head>
  <body class="boards-page">
    <div class="container">
      <h1>Boards</h1>
      
      <div id="error-message" class="error" style="display: none;"></div>
      
      <div class="controls">
        <input 
          type="text" 
          id="search-input" 
          class="search-input" 
          placeholder="Search boards by name..."
        />
        <button id="create-button" class="create-button">Create New Board</button>
      </div>
      
      <div id="loading" class="loading" style="display: none;">Loading boards...</div>
      
      <table id="boards-table" style="display: none;">
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="createOn">Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="boards-tbody">
        </tbody>
      </table>
      
      <div id="empty-state" class="empty-state" style="display: none;">
        <p>No boards found.</p>
      </div>
      
      <div id="pagination" class="pagination" style="display: none;">
        <div class="pagination-info">
          <span id="pagination-info-text"></span>
        </div>
        <div class="pagination-controls">
          <button id="load-more-button" class="pagination-button">Load More</button>
        </div>
      </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
    <script type="module">
      import { initializeFirebaseApp } from "./scripts/config/firebase-config.js";
      import { ensureAuthenticatedIfOnline } from "./scripts/ui/auth-helpers.js";
      import { FirestoreStore } from "./scripts/network/network-firestore.js";
      import { LocalDatastore } from "./scripts/board/local-datastore.js";
      
      // Global debug mode setting - controlled by query parameter
      const urlParams = new URLSearchParams(window.location.search);
      window.DEBUG_MODE = urlParams.get('debug') === 'true';
      
      // Initialize Firebase config
      initializeFirebaseApp();
      
      // Check for offline query parameter
      const isOffline = urlParams.get('offline') === 'true';
      
      // State
      let allBoards = []; // Accumulated boards from Firestore (or all boards from local)
      let filteredBoards = [];
      let displayedBoards = [];
      let pageSize = 50;
      let sortColumn = 'createOn';
      let sortDirection = 'desc';
      let searchTerm = '';
      
      // Firestore pagination state
      let lastCursor = null; // Cursor for next page from Firestore
      let hasMore = false; // Whether there are more results to load
      let isLoadingMore = false; // Whether we're currently loading more results
      
      // Search debounce state
      let searchDebounceTimer = null;
      const SEARCH_DEBOUNCE_MS = 300; // UI-level debounce delay
      
      // DOM elements
      const searchInput = document.getElementById('search-input');
      const createButton = document.getElementById('create-button');
      const boardsTable = document.getElementById('boards-table');
      const boardsTbody = document.getElementById('boards-tbody');
      const emptyState = document.getElementById('empty-state');
      const loadingDiv = document.getElementById('loading');
      const errorDiv = document.getElementById('error-message');
      const paginationDiv = document.getElementById('pagination');
      const paginationInfo = document.getElementById('pagination-info-text');
      const loadMoreButton = document.getElementById('load-more-button');
      
      // Format date
      function formatDate(timestamp) {
        if (!timestamp) return 'Unknown';
        const date = new Date(timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      }
      
      // Load boards (initial load or search reset)
      async function loadBoards(reset = true) {
        try {
          if (reset) {
            loadingDiv.style.display = 'block';
            boardsTable.style.display = 'none';
            emptyState.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Reset pagination state
            allBoards = [];
            lastCursor = null;
            hasMore = false;
          } else {
            // Loading more - just show loading indicator on button
            isLoadingMore = true;
            loadMoreButton.disabled = true;
            loadMoreButton.textContent = 'Loading...';
          }
          
          if (isOffline) {
            // Use LocalDatastore - no pagination, load all at once
            const datastore = new LocalDatastore();
            const searchResults = datastore.searchBoards(searchTerm);
            if (reset) {
              allBoards = searchResults;
            } else {
              // Local doesn't support pagination, so this shouldn't be called
              allBoards = searchResults;
            }
            hasMore = false;
            lastCursor = null;
          } else {
            // Use FirestoreStore with pagination
            const user = await ensureAuthenticatedIfOnline(isOffline);
            const userId = user ? user.uid : null;
            const result = await FirestoreStore.searchBoards(searchTerm, userId, {
              limit: pageSize,
              startAfter: reset ? null : lastCursor
            });
            
            if (reset) {
              allBoards = result.boards;
            } else {
              // Append to existing boards
              allBoards = [...allBoards, ...result.boards];
            }
            
            lastCursor = result.cursor;
            hasMore = result.hasMore || false;
          }
          
          applyFilters();
          renderBoards();
          
          if (reset) {
            loadingDiv.style.display = 'none';
          } else {
            isLoadingMore = false;
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = 'Load More';
          }
        } catch (error) {
          // Log full error details including stack trace
          console.error('Error loading boards:', error);
          console.error('Error stack:', error.stack);
          console.error('Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack,
            code: error.code,
            fullError: error
          });
          
          // Show detailed error message
          const errorDetails = [
            error.message || 'Unknown error',
            error.stack ? `\n\nStack trace:\n${error.stack}` : '',
            error.code ? `\n\nError code: ${error.code}` : ''
          ].filter(Boolean).join('');
          
          errorDiv.textContent = `Error loading boards: ${errorDetails}`;
          errorDiv.style.display = 'block';
          
          if (reset) {
            loadingDiv.style.display = 'none';
          } else {
            isLoadingMore = false;
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = 'Load More';
          }
        }
      }
      
      // Apply search filter and sorting
      // Note: For Firestore, search filtering is done server-side, but we still filter here
      // for local datastore and to handle any client-side filtering needs
      function applyFilters() {
        let filtered = [...allBoards];
        
        // Apply search filter (for local datastore; Firestore already filters)
        if (searchTerm.trim() && isOffline) {
          const searchLower = searchTerm.toLowerCase();
          filtered = filtered.filter(board => {
            const title = (board.title || board.name).toLowerCase();
            return title.includes(searchLower);
          });
        }
        
        // Apply sorting (Firestore already sorts, but we sort here for consistency and local)
        filtered.sort((a, b) => {
          let aVal = a[sortColumn];
          let bVal = b[sortColumn];
          
          if (sortColumn === 'createOn') {
            aVal = aVal || 0;
            bVal = bVal || 0;
          } else if (sortColumn === 'name') {
            // When sorting by name, use title instead
            aVal = (a.title || a.name || '').toString().toLowerCase();
            bVal = (b.title || b.name || '').toString().toLowerCase();
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
          }
          
          if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
          } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          }
        });
        
        filteredBoards = filtered;
      }
      
      // Render boards
      function renderBoards() {
        // Display all filtered boards (no client-side pagination)
        displayedBoards = filteredBoards;
        
        // Clear table
        boardsTbody.innerHTML = '';
        
        if (displayedBoards.length === 0) {
          boardsTable.style.display = 'none';
          emptyState.style.display = 'block';
          paginationDiv.style.display = 'none';
          return;
        }
        
        boardsTable.style.display = 'table';
        emptyState.style.display = 'none';
        
        // Render rows
        displayedBoards.forEach(board => {
          const row = document.createElement('tr');
          
          const nameCell = document.createElement('td');
          const nameLink = document.createElement('a');
          nameLink.className = 'board-name';
          // Display title instead of board ID, fallback to board ID if no title
          nameLink.textContent = board.title || board.name;
          nameLink.href = `board.html?boardName=${encodeURIComponent(board.name)}${isOffline ? '&offline=true' : ''}`;
          nameCell.appendChild(nameLink);
          
          const dateCell = document.createElement('td');
          dateCell.textContent = formatDate(board.createOn);
          
          const actionCell = document.createElement('td');
          const openButton = document.createElement('button');
          openButton.className = 'action-button';
          openButton.textContent = 'Open';
          openButton.onclick = () => {
            window.location.href = `board.html?boardName=${encodeURIComponent(board.name)}${isOffline ? '&offline=true' : ''}`;
          };
          actionCell.appendChild(openButton);
          
          const deleteButton = document.createElement('button');
          deleteButton.className = 'action-button delete-button';
          deleteButton.textContent = 'Delete';
          deleteButton.onclick = async () => {
            const boardTitle = board.title || board.name;
            const confirmed = confirm(`Are you sure you want to delete "${boardTitle}"?\n\nThis action cannot be undone.`);
            
            if (!confirmed) {
              return;
            }
            
            try {
              if (isOffline) {
                // Use LocalDatastore
                const datastore = new LocalDatastore();
                const deleted = datastore.deleteBoard(board.name);
                if (deleted) {
                  // Reload boards list
                  loadBoards(true);
                } else {
                  errorDiv.textContent = 'Failed to delete board';
                  errorDiv.style.display = 'block';
                }
              } else {
                // Use FirestoreStore
                const user = await ensureAuthenticatedIfOnline(isOffline);
                const userId = user ? user.uid : null;
                const deleted = await FirestoreStore.deleteBoard(board.name, userId);
                if (deleted) {
                  // Reload boards list
                  loadBoards(true);
                } else {
                  errorDiv.textContent = 'Board not found or already deleted';
                  errorDiv.style.display = 'block';
                }
              }
            } catch (error) {
              console.error('Error deleting board:', error);
              errorDiv.textContent = `Error deleting board: ${error.message}`;
              errorDiv.style.display = 'block';
            }
          };
          actionCell.appendChild(deleteButton);
          
          row.appendChild(nameCell);
          row.appendChild(dateCell);
          row.appendChild(actionCell);
          boardsTbody.appendChild(row);
        });
        
        // Update pagination info and load more button
        paginationInfo.textContent = `Showing ${displayedBoards.length} board${displayedBoards.length === 1 ? '' : 's'}`;
        
        // Show load more button only if there are more results (Firestore only)
        if (!isOffline && hasMore) {
          paginationDiv.style.display = 'flex';
          loadMoreButton.style.display = 'block';
        } else {
          // Hide load more button if no more results
          loadMoreButton.style.display = 'none';
          // Still show pagination div if there are boards, to show count
          if (displayedBoards.length > 0) {
            paginationDiv.style.display = 'flex';
          } else {
            paginationDiv.style.display = 'none';
          }
        }
      }
      
      // Sort handler
      function handleSort(column) {
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        
        // Update sort indicators
        document.querySelectorAll('.sortable').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
          if (th.dataset.sort === sortColumn) {
            th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
        
        applyFilters();
        renderBoards();
      }
      
      // Event listeners
      searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value;
        
        // Clear any existing debounce timer
        if (searchDebounceTimer) {
          clearTimeout(searchDebounceTimer);
        }
        
        // Set a new debounce timer
        searchDebounceTimer = setTimeout(() => {
          searchDebounceTimer = null;
          // Reset and reload when search changes (after debounce delay)
          loadBoards(true);
        }, SEARCH_DEBOUNCE_MS);
      });
      
      createButton.addEventListener('click', () => {
        const boardName = prompt('Enter board name:');
        if (boardName) {
          window.location.href = `board.html?boardName=${encodeURIComponent(boardName)}${isOffline ? '&offline=true' : ''}`;
        }
      });
      
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          handleSort(th.dataset.sort);
        });
      });
      
      loadMoreButton.addEventListener('click', () => {
        if (!isLoadingMore && hasMore) {
          loadBoards(false); // Load more without resetting
        }
      });
      
      // Initialize
      loadBoards();
    </script>
  </body>
</html>
