<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Whiteboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/board.css" />
    <style>
      #error-retry:hover {
        background-color: #2a2a9e;
      }
      #error-retry:active {
        transform: translateY(0.1em);
        background-color: #1f1f70;
      }
    </style>
  </head>
  <body>
    <div class="app"></div>
    <div id="error-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
      <div style="background: #fff; padding: 24px; border-radius: 4px; width: min(420px, 90vw); box-shadow: 1px 1px 3px 0px rgba(0, 0, 0, 0.36); border: 1px solid #e0e0e0;">
        <h3 id="error-title" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #333;">Error</h3>
        <div id="error-message" style="margin: 0 0 20px 0; white-space: pre-line; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #333; line-height: 1.5;"></div>
        <button id="error-retry" style="padding: 8px 16px; border: none; border-radius: 4px; background-color: #4646d8; color: #fff; cursor: pointer; font-size: 16px; font-weight: 400; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; transition: background-color 0.2s ease;">Try again</button>
      </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
    <script type="module">
      // Global debug mode setting - controlled by query parameter
      const urlParams = new URLSearchParams(window.location.search);
      window.DEBUG_MODE = urlParams.get('debug') === 'true';
      
      // Initialize Firebase config on window load
      import { initializeFirebaseApp } from "./scripts/config/firebase-config.js";
      initializeFirebaseApp();
    </script>
    <script type="module">
      import { mount } from "./scripts/ui/render-to-dom.js";
      import { Board } from "./scripts/board/board.js";
      import { getAppState } from "./scripts/app-state.js";
      import { BufferedObserver } from "./scripts/ui/buffered-observer.js";
      import { FirestoreStore } from "./scripts/network/network-firestore.js";
      import { LocalDatastore } from "./scripts/board/local-datastore.js";
      import { LocalStoragePersistence } from "./scripts/board/local-storage-persistence.js";
      import { showError } from "./scripts/ui/error-overlay.js";
      import { ensureAuthenticatedIfOnline } from "./scripts/ui/auth-helpers.js";
      
      // Check for offline query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const isOffline = urlParams.get('offline') === 'true';
      // Get boardName from query string, default to "my-board2" if not provided
      const boardName = urlParams.get('boardName');
      
      async function bootstrap() {
        // Check if boardName is required and provided (only needed when not offline)
        if (!isOffline && !boardName) {
          showError(
            'A board name was not specified and is required.',
            null,
            'Board name required'
          );
          return; // Prevent bootstrap from continuing
        }
        
        await ensureAuthenticatedIfOnline(isOffline);
        let store;
        let persistence;
        if (isOffline) {
          // Use local storage
          store = new LocalDatastore();
          const offlineBoardName = boardName || 'default-board';
          persistence = new LocalStoragePersistence(offlineBoardName);
          // Initialize app state from LocalStorage
          persistence.initializeAppState(offlineBoardName);
          // Add persistence as an observer to the store
          store.addObserver(persistence);
        } else {
          // Use Firestore
          store = new FirestoreStore(boardName);
        }
        const board = new Board(store);
        mount(board, document.querySelector(".app"), BufferedObserver, store);
        await store.connect();
        // expose app state for debugging
        window.appState = getAppState();
      }
      
      bootstrap();
    </script>
  </body>
</html>
