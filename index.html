<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Whiteboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/board.css" />
    <style>
      #error-retry:hover {
        background-color: #2a2a9e;
      }
      #error-retry:active {
        transform: translateY(0.1em);
        background-color: #1f1f70;
      }
    </style>
  </head>
  <body>
    <div class="app"></div>
    <div id="error-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
      <div style="background: #fff; padding: 24px; border-radius: 4px; width: min(420px, 90vw); box-shadow: 1px 1px 3px 0px rgba(0, 0, 0, 0.36); border: 1px solid #e0e0e0;">
        <h3 id="error-title" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #333;">Error</h3>
        <div id="error-message" style="margin: 0 0 20px 0; white-space: pre-line; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #333; line-height: 1.5;"></div>
        <button id="error-retry" style="padding: 8px 16px; border: none; border-radius: 4px; background-color: #4646d8; color: #fff; cursor: pointer; font-size: 16px; font-weight: 400; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; transition: background-color 0.2s ease;">Try again</button>
      </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
    <script>
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyDhvmtdhl4SNpA8XhvHeK_1mFyVfaEa66k",
        authDomain: "sticky-board-b7062.firebaseapp.com",
        databaseURL: "https://sticky-board-b7062.firebaseio.com",
        projectId: "sticky-board-b7062",
        storageBucket: "sticky-board-b7062.firebasestorage.app",
        messagingSenderId: "1017840154919",
        appId: "1:1017840154919:web:05494ae3b80e71ecf5d102",
        measurementId: "G-CXTXNN5XSM"
      };
      window.firebaseConfig = firebaseConfig;
      
      // Global debug mode setting - controlled by query parameter
      const urlParams = new URLSearchParams(window.location.search);
      window.DEBUG_MODE = urlParams.get('debug') === 'true';
    </script>
    <script type="module">
      import { mount } from "./scripts/ui/render-to-dom.js";
      import { Board } from "./scripts/board/board.js";
      import { getAppState } from "./scripts/app-state.js";
      import { BufferedObserver } from "./scripts/ui/buffered-observer.js";
      import { FirestoreStore } from "./scripts/network/network-firestore.js";
      import { LocalDatastore } from "./scripts/board/local-datastore.js";
      import { LocalStoragePersistence } from "./scripts/board/local-storage-persistence.js";
      
      // Check for offline query parameter
      const isOffline = urlParams.get('offline') === 'true';
      // Get boardName from query string, default to "my-board2" if not provided
      const boardName = urlParams.get('boardName');
      
      // Helper to show error UI and bind retry handler
      function showError(message, onRetry, title = 'Error') {
        const overlay = document.getElementById('error-overlay');
        const errorMessage = document.getElementById('error-message');
        const errorTitle = document.getElementById('error-title');
        const retryButton = document.getElementById('error-retry');
        
        errorTitle.textContent = title;
        errorMessage.textContent = message || 'An error occurred.';
        overlay.style.display = 'flex';
        
        // Show or hide retry button based on whether onRetry is provided
        if (onRetry) {
          retryButton.style.display = 'block';
          // Remove any existing handler and add new one
          const newRetryButton = retryButton.cloneNode(true);
          retryButton.parentNode.replaceChild(newRetryButton, retryButton);
          newRetryButton.addEventListener('click', onRetry);
        } else {
          retryButton.style.display = 'none';
        }
        
        return {
          updateMessage(newMsg) { 
            const msgEl = document.getElementById('error-message');
            if (msgEl) msgEl.textContent = newMsg; 
          },
          hide() { 
            const overlayEl = document.getElementById('error-overlay');
            if (overlayEl) overlayEl.style.display = 'none'; 
          }
        };
      }
      
      async function ensureAuthenticatedIfOnline() {
        if (isOffline) {
          return null; // no auth required
        }
        // Initialize Firebase app if not already
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        
        // Try to resolve a pending redirect result first (from prior session)
        try {
          const redirectResult = await auth.getRedirectResult();
          if (redirectResult && redirectResult.user) {
            return redirectResult.user;
          }
        } catch (e) {
          // ignore here; we'll show UI below if needed
        }
        
        // Wait for current auth state
        const currentUser = await new Promise((resolve) => {
          const unsubscribe = auth.onAuthStateChanged((user) => {
            unsubscribe();
            resolve(user);
          });
        });
        if (currentUser) {
          return currentUser;
        }
        
        // Attempt popup sign-in; on error, show UI and allow retries
        const provider = new firebase.auth.GoogleAuthProvider();
        async function attemptPopupSignIn() {
          try {
            const result = await firebase.auth().signInWithPopup(provider);
            if (result && result.user) {
              return result.user;
            }
            throw new Error('Sign-in completed but no user returned');
          } catch (error) {
            // Check for popup blocked error - in this case, fall back to redirect
            if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
              // If popup is blocked, try redirect instead
              throw new Error('Popup was blocked. Please allow popups for this site and try again, or the browser may redirect you automatically.');
            }
            // Re-throw other errors
            throw error;
          }
        }
        
        function formatAuthErrorMessage(error) {
          const code = error && error.code ? String(error.code) : '';
          const msg = error && error.message ? String(error.message) : '';
          if (code.includes('auth/unauthorized-domain')) {
            return 'Sign-in is not allowed from this domain. In Firebase Console → Authentication → Settings, add this origin (e.g. localhost:9000) to Authorized domains.';
          }
          if (msg.includes('404') || code.includes('404')) {
            return 'Authentication handler redirect failed. The redirect after sign-in returned a 404. This may indicate:\n- The redirect URL format is incorrect\n- A network or configuration issue\n\nPlease check the browser console for more details and ensure you are accessing the app from the correct URL (http://localhost:9000).';
          }
          if (code === 'auth/popup-blocked') {
            return 'Popup was blocked by your browser. Please allow popups for this site and try again.';
          }
          if (code === 'auth/popup-closed-by-user') {
            return 'Sign-in popup was closed before completing. Please try again.';
          }
          return msg || 'Authentication failed. Please try again.';
        }

        try {
          const user = await attemptPopupSignIn();
          return user;
        } catch (e) {
          // Log detailed error info to help debug the 404 redirect issue
          if (window.DEBUG_MODE) {
            console.error('[Auth Error]', {
              code: e?.code,
              message: e?.message,
              email: e?.email,
              credential: e?.credential,
              error: e
            });
          }
          
          let overlay;
          const handleRetry = async () => {
            try {
              overlay.updateMessage('Retrying sign-in...');
              const user = await attemptPopupSignIn();
              overlay.hide();
              resolveRetry(user);
            } catch (err) {
              if (window.DEBUG_MODE) {
                console.error('[Auth Retry Error]', {
                  code: err?.code,
                  message: err?.message,
                  error: err
                });
              }
              overlay.updateMessage(formatAuthErrorMessage(err));
            }
          };
          let resolveRetry;
          const userPromise = new Promise((resolve) => { resolveRetry = resolve; });
          overlay = showError(formatAuthErrorMessage(e), handleRetry, 'Sign-in required');
          return await userPromise;
        }
      }
      
      async function bootstrap() {
        // Check if boardName is required and provided (only needed when not offline)
        if (!isOffline && !boardName) {
          showError(
            'A board name was not specified and is required.',
            null,
            'Board name required'
          );
          return; // Prevent bootstrap from continuing
        }
        
        await ensureAuthenticatedIfOnline();
        let store;
        let persistence;
        if (isOffline) {
          // Use local storage
          store = new LocalDatastore();
          persistence = new LocalStoragePersistence();
          // Initialize app state from LocalStorage
          persistence.initializeAppState();
          // Add persistence as an observer to the store
          store.addObserver(persistence);
        } else {
          // Use Firestore
          store = new FirestoreStore(boardName);
        }
        const board = new Board(store);
        mount(board, document.querySelector(".app"), BufferedObserver, store);
        store.connect();
        // expose app state for debugging
        window.appState = getAppState();
      }
      
      bootstrap();
    </script>
  </body>
</html>
